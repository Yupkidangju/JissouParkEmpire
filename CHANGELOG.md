# 변경 이력 (Changelog)

이 프로젝트의 모든 주요 변경사항을 기록한다.
형식은 [Keep a Changelog](https://keepachangelog.com/ko/1.0.0/)를 따르며,
버전 관리는 [Semantic Versioning](https://semver.org/lang/ko/)을 준수한다.

## [Unreleased]

### 예정됨 (Planned)
- **Phase 9: 안드로이드 솔플 APK 빌드** (Kivy/BeeWare 기반)

## [1.6.0] - 2026-02-21

### 변경됨 (Changed)
- **AP 시스템 근본 재설계**: `consume_turn()`을 AP 소비 래퍼로 전환
  - 이전: 매 행동마다 턴 진행 → AP 무력화(Ghost AP 버그)
  - 이후: AP 충분하면 AP만 감소, AP 부족 시에만 턴 진행 + AP 리셋
  - `action_gather/birth/build/train` 내부 중복 AP 체크/소비 제거
  - 각 라우트에서 `consume_turn(park, ap_cost=N)` 호출로 통일

### 보안 (Security)
- **원자적 에스크로**: `trade_create`에서 SQL 레벨 `UPDATE-WHERE` 차감
  - `@validates` 음수 클램핑 역설 근본 차단 (동시 100 요청에도 DB가 1건만 통과)
  - Python 객체 `db.session.refresh()` 동기화

### 수정됨 (Fixed)
- **교역 연산 순서 수정**: 뺄셈(줄 것) 먼저 → 덧셈(받을 것) 나중
  - 이전: 더하기 → cap 잘림 → 빼기 = 자원 증발
  - 이후: 빼기 → 더하기 → cap 적용 = 정확한 교환

## [1.5.1] - 2026-02-21

### 보안 (Security)
- **디버그 백도어 차단**: `debug/next-turn` 라우트에 `DEBUG` 모드 전용 가드 추가 (프로덕션 무한 턴 Exploit 차단)
- **교역 에스크로 시스템**: 교역 등록 시 제안 자원을 즉시 선차감, 취소 시 환불 (유령 자원 복사 Exploit 차단)
- **음수 자원 교역 차단**: offer/request 값에 `max(0, ...)` 적용 (음수 역전 Exploit 방지)
- **교역 메시지 XSS 차단**: `html.escape()` 적용
- **int() 크래시 방지**: `request.form.get(type=int)` 안전 파싱으로 전환 (5곳)

### 수정됨 (Fixed)
- **보스 단독 무손실 파밍**: 보스 단독 출전 시 승리해도 HP 3~8 감소 + 전투력 30% 패널티
- **교역 수락 로직**: 에스크로 반영으로 발송자 이중 감산 제거

## [1.5.0] - 2026-02-21

### 보안 (Security)
- **XSS 취약점 차단**: Toast 알림 + 정찰 모달에서 `innerHTML` → `textContent`/`escapeHtml()` 전환
  - `escapeHtml()` 글로벌 유틸 함수 추가 (HTML 특수문자 이스케이프)
  - 정찰 데이터 숫자값 `Number()` 캐스팅으로 타입 안전성 확보
- **공원 이름 특수문자 차단**: 가입 시 `<>&"'/\` 포함 이름 거부 (XSS 근본 원인 차단)
- **교역 Double Spend 방지**: 원자적 `UPDATE-WHERE` 패턴으로 동시 수락 차단
  - `status='pending'` → `status='processing'` 원자적 전환 후 교환 실행
  - 실패 시 상태 원복 로직 추가
- **자원 음수 방어**: 교역 자원 감산에 `max(0, ...)` 클램핑 적용

### 수정됨 (Fixed)
- **저실장 무한 번식 Exploit**: 출산 시 `baby_cap` 검사 추가
  - 운치굴 없어도 최소 5마리(BASE_BABY_CAP) 보유 가능
  - 운치굴 수용량 초과 시 저실장 출산 차단
- **모델 레벨 음수 방어**: `Park` 모델에 `@validates` 데코레이터 적용
  - 인구(guard/adult/child/baby), 자원(konpeito/trash/meat/material), boss_hp, morale, AP, 턴 12개 필드
  - 어디서든 음수 설정 시 자동 0 클램핑 (DB 무결성 보호)
  - 멀티플레이 요소 제거 (인증/교역/외교 → NPC 자동화)
  - Python 게임 로직 100% 재사용 (game_engine, battle_engine, npc_engine, dialogues)
  - SQLite + JSON i18n 그대로 이식
  - Kivy 위젯 기반 네이티브 UI 재작성
  - Google Play 스토어 등록 (무료 배포)
  - 틈새시장 타겟: 일본/중국 실장석 팬층

## [1.4.0] - 2026-02-17

### 추가됨 (Added)
- **UI 전면 i18n 적용**: HTML 템플릿 + Python flash 메시지 완전 국제화
  - `register.html`: NPC 대사, 헤더, 초기자원 안내 → `{{ t('key') }}`
  - `login.html`: 태그라인, 제목, 헤더 → `{{ t('key') }}`
  - `gameover.html`: 게임오버 대사, 스탯 라벨, 멸망 안내 → `{{ t('key') }}`
  - `ranking.html`: 정렬 탭, 테이블 헤더, 내 공원 요약 → `{{ t('key') }}`
  - `battle_logs.html`: 전투 결과 배지, 빈 로그 메시지 → `{{ t('key') }}`
  - `base.html`: 기본 title 하드코딩 제거
  - `auth_routes.py`: 13개 flash 메시지 → `get_text()` 호출
  - `game_routes.py`: 40+개 flash 메시지 → `get_text()` 호출
- **i18n 키 대폭 확장**: 5개 언어 파일 모두 258키로 동기화
  - `flash.auth_*` (인증), `flash.reg_*` (가입), `gameover.*` (게임오버)
  - `ranking.*` (랭킹), `battle.*` (전투), `diplo.*` (외교), `dash.*` (대시보드)

## [1.3.0] - 2026-02-17

### 추가됨 (Added)
- **보호 모드 시스템**: 약한 공원(경호<5 OR 성체<15) 자동 보호
  - 보호 중: 침공 불가 + 침공 당하지 않음
  - 진입 시 자원/인구 최소 보장 수준으로 재배치 (성체5, 자실장15, 저실장8, 음쓰50, 콘페이토8, 자재80)
  - 보스 HP 50↑, 사기 30↑ 최소 보장
  - NPC도 보호 대상 건너뜀
  - 대시보드에 🛡️ 보호 모드 배너 표시 (경호/성체 진행률)
  - 해제 조건: 경호 ≥ 5 AND 성체 ≥ 15
- **대사 다국어 시스템(i18n)**: 619줄 하드코딩 대사를 JSON 기반으로 추상화
  - 5개 언어 대사 파일: dialogues_ko.json, dialogues_en.json, dialogues_ja.json, dialogues_zh_tw.json, dialogues_zh_cn.json
  - Python 3.7+ 모듈 __getattr__ 기반 프록시로 기존 코드 100% 호환
  - Flask 세션 언어 자동 감지, 폴백(ko) 지원
  - 말투: ko(~데스), ja(~でち), en(~desu), zh(~的說/的说)

## [1.2.0] - 2026-02-17

### 추가됨 (Added)
- **모바일 턴 쿼터 시스템**: 글로벌 타이머 → 개인별 턴 스태미나 전환
  - 최대 15턴 보유, 20분당 1턴 자동 충전
  - 접속 시 타임스탬프 기반 온디맨드 충전 (서버 부담 0)
  - 턴 게이지 바 + 실시간 카운트다운 타이머 UI
  - 행동 시 턴 1개 소비 → `process_turn()` 실행
  - NPC 동기 처리 (플레이어 턴 소비 시 NPC도 진행)
- **반응형 모바일 CSS**: 768px/480px 브레이크포인트 미디어 쿼리
  - 단일 컬럼 레이아웃 (모바일)
  - 터치 친화적 버튼 (min-height 48px)
  - iOS 폼 확대 방지 (font-size: 16px)
  - 턴 게이지 모바일 세로 배치
- **DB 마이그레이션**: `migrate_v1_2.py` (turn_quota, last_turn_regen_at)

### 변경됨 (Changed)
- 모든 행동(채집/출산/건설/훈련/침공)에 턴 소비 로직 적용
- 대시보드 접속 시 턴 자동 충전 + 턴 정보 표시
- CSS 중복 미디어 쿼리 정리 (v0.3.0 잔여 → v1.2.0 통합)


## [1.1.0] - 2026-02-17

### 추가됨 (Added)
- **재해 & 환경 이벤트**: 폭우(골판지집 파괴), 한파(동사), 살충제(저실장 사망),
  쥐떼(식량+저실장), 고양이(자실장), 쓰레기장 철거(채집 패널티)
- **출산 잔혹 이벤트**: 사산(5%), 기형(10%), 대량출산(8%),
  모체 사망(2%), 기아 시 출산 포식(3%)
- **자동 카니발리즘**: 식량 0 시 경호실장이 자실장 강제 포식 + 사기 대폭 감소
- **질병 시스템**: 과밀(90%+운치굴3개) 시 전염병 발생, 콘페이토 5개로 치료
- **NPC 악행 이벤트**: 학대자(납치), 실험체(포획), 어린이(장난), 착한 인간(선물), 펫샵(포획)
- **밀사/침투 시스템**: 1AP+성체1로 적 공원 사보타주, 40% 발각 확률, 감시탑 방어 보너스
- **반란 시스템**: 사기 20↓ 시 자실장 탈주/성체 태업, 보스HP 30↓ 시 경호 쿠데타
- **콘페이토 중독**: 3턴 연속 섭취 → 중독, 채집 50% 감소, 3턴 미섭취 시 해독
- **SpyMission 모델**: `spy_missions` 테이블 추가 (밀사 임무 추적)
- **DB 마이그레이션**: `migrate_v1_1.py` (새 필드 6개 + SpyMission 테이블)

### 변경됨 (Changed)
- `process_turn`: 13단계 처리 순서로 확장 (기존 6단계 → 13단계)
- `action_gather`: 태업/채집패널티/중독 효과 적용
- `action_build`: 태업 시 건설 불가
- `action_birth`: 출산 잔혹 이벤트 5종 통합

## [1.0.0] - 2026-02-17

### 추가됨 (Added)
- **다국어 지원 (i18n)**: JSON 기반 경량 번역 시스템
  - 지원 언어: 한국어, 영어, 일본어, 중국어 번체, 중국어 간체
  - 세션 기반 언어 저장 + 즉시 전환
  - 모든 페이지 상단에 언어 선택 바 추가
  - 템플릿에서 `{{ t('key') }}` 함수로 번역 텍스트 사용
  - `app/lang/` 디렉토리에 JSON 파일로 관리
- **배포 가이드** (`BUILD_GUIDE.md`): 라즈베리파이 프로덕션 배포
  - Gunicorn WSGI 서버 설정
  - systemd 서비스 등록 스크립트
  - Nginx 리버스 프록시 설정 (정적 파일 직접 서빙)
  - 방화벽, 성능 최적화, 트러블슈팅 가이드
- **i18n 모듈** (`app/i18n.py`): Flask 앱 팩토리와 통합

## [0.4.0] - 2026-02-17

### 추가됨 (Added)
- **교역 시스템** (`/game/trade`): 공원 간 자원 교환
  - 공개 교역 (아무나 수락 가능) / 지정 교역 (특정 공원 대상)
  - 자원 종류: 콘페이토, 음쓰, 자재, 저실장
  - 교역 제안 생성, 수락, 거절, 취소 기능
  - 보유량 검증 (양측 자원 부족 시 자동 만료)
  - 교역 메시지 기능
- **외교 시스템**: 동맹/적대 관계 관리
  - 🤝 동맹: NPC는 즉시 수락, 플레이어는 요청→수락 구조
  - ⚔️ 적대: 일방적 선언, 즉시 활성화
  - 동맹 파기 / 적대 해제 기능
  - 동맹인 공원 침공 차단
  - 적대 공원 침공 시 약탈 +20% 보너스
- **교역/외교 통합 UI** (`trade.html`): 교역소 & 외교관 페이지
- **대시보드 하단 네비게이션에 교역/외교 바로가기 추가**
- **DB 모델**: `TradeOffer`, `Diplomacy` 테이블 추가

- **실시간 알림 시스템**: 대시보드에서 10초 폴링으로 침공/교역/외교 이벤트 토스트 알림
  - 타입별 색상/아이콘 구분 (전투: 빨강, 교역: 주황, 외교: 파랑)
  - 클릭 시 닫기 + 5초 후 자동 사라짐
  - API: `/game/api/notifications?last_id=N`

## [0.3.0] - 2026-02-17

### 추가됨 (Added)
- **전투 유닛 선택 시스템**: 침공 시 경호실장/성체실장 출정 인원을 직접 지정
  - 침공 모달 UI (경호·성체 인원 입력 + 가용 수 표시)
  - 예상 전투력 실시간 미리보기
  - 출정 인원 0명이면 버튼 비활성화
- **보스실장 참전**: 보스 직접 출전 옵션 (전투력 +100)
  - 패배 시 보스 HP -10~25 (보스 사망 = 게임오버)
  - 참전 위험도 경고 + 현재 보스 HP 표시
- **게임오버 재시작**: 멸망 후 새 공원 생성으로 재시작
  - 최종 생존 통계 표시 (턴 수, 잔존 인구)
  - 랭킹 보기 버튼
- **전투 사기 연동**: 승리 시 사기 +8 / 패배 시 사기 -8
  - 방어 성공 시 사기 +5
- **랭킹 시스템** (`ranking.html`, `/game/ranking`): 전체 공원 순위 조회
  - 정렬 기준: 전투력 / 인구 / 승수 / 자원 (탭 전환)
  - 내 공원 강조 + 순위 요약 표시
  - NPC 성격별 색상 표시
- **정찰 시스템** (`/game/scout/<id>`): AJAX 기반 적 공원 정보 조회
  - 감시탑 유무에 따라 정보 수준 차등 (기본 vs 상세)
  - 팝업 모달 UI
- **채집 인원 기억 기능**: 성체/자실장 배치 수를 DB에 저장 + 턴 리셋 없이 유지
- **대시보드 하단 네비게이션**: 랭킹 + 전투기록 바로가기

### 변경됨 (Changed)
- 침공 UI: 바로 전투 → 유닛 선택 모달 → 출정 구조로 변경
- 전투 엔진: 전체 병력 출정 → 지정 유닛만 출정으로 개선
- 전투 로그에 출정 편성 정보 (경호 N + 성체 N + 보스 참전 여부) 기록
- 건설 UI 개선: 자재 부족 표시 + 건물 설명 동적 업데이트
- 턴 처리 시 채집/방어 인원을 보유 수에 맞게 자동 조정
- NPC 성격별 패시브 성장 차등화 (목장=인구, 야만=군사, 교활=콘페이토)
- NPC 침공 시 유닛 선택 로직 추가 (교활형은 경호만 소수 파견)

### 보안 (Security)
- Flask-WTF CSRFProtect 전역 적용 (모든 POST 요청에 CSRF 토큰 필수)
- base.html에서 meta 태그로 CSRF 토큰 주입 + JS 자동 삽입

### UI/UX
- 반응형 CSS 미디어 쿼리 추가 (768px 태블릿, 480px 모바일)
- 버튼 호버 마이크로 애니메이션 (translateY + box-shadow)
- 플래시 메시지 슬라이드-인 효과
- 박스 헤더 글로우 펄스, 전투력 수치 펄스 애니메이션
- 게임오버 화면 전용 CSS (death-pulse 애니메이션)
- 침공 모달 입력 필드 스타일링 (.num-input)

## [0.2.0] - 2026-02-17

### 추가됨 (Added)
- **턴 스케줄러** (`turn_scheduler.py`): APScheduler 기반 자동 턴 처리
  - 매 TURN_INTERVAL(기본 10분)마다 모든 공원의 턴을 일괄 처리
  - 디버그용 수동 턴 진행 기능 (`/game/debug/next-turn`)
- **NPC AI 엔진** (`npc_engine.py`): 5종 성격별 자동 행동 시스템
  - aggressive: 침공 우선, defensive: 방벽 건설 우선
  - peaceful: 채집/출산 우선, cunning: 약한 공원만 침공
  - berserk: 무조건 침공, 식량 없으면 솎아내기
- **전투 엔진** (`battle_engine.py`): 침공/방어 전투 시뮬레이션
  - 전투력 계산 (사기/방벽/감시탑 보정)
  - 랜덤 승패 판정 및 양측 사상자 계산
  - 약탈 시스템 (자원 + 인구 포획)
  - 전투 로그 기록 및 대사 연동
- **방어 배치 시스템** (`/game/defend`): 경호/성체 실장을 방어에 배치
- **전투 기록 페이지** (`battle_logs.html`): 과거 전투 결과 조회
- **전투 대사 확장** (`dialogues.py`): 출정/승리/패배/약탈/방어 대사 추가
- **대시보드 전투 UI**: 침공 버튼, 방어 배치 패널, 디버그 턴 버튼
- **CSS 로고 박스**: ASCII 박스 대신 CSS border + glow 로고 (한글 깨짐 방지)

### 변경됨 (Changed)
- 로그인/회원가입 로고를 CSS 기반 `.logo-box`로 교체
- 게임오버 화면 ASCII 아트를 CSS + `<pre>` 분리 구조로 개선
- `Park` 모델에 `consecutive_trash_turns` 필드 추가 (사기 페널티)
- `__init__.py`에 루트 URL 리다이렉트 및 스케줄러 초기화 추가

## [0.1.0] - 2026-02-17

### 추가됨 (Added)
- 프로젝트 초기 설정
- 게임 기획서 (spec.md) 작성
  - 실장석 세계관 기반 턴제 전략 게임 설계
  - 5단계 실장석 계급 체계 (보스/경호/성체/자실장/저실장)
  - 3종 식량 시스템 (콘페이토 10NP / 음식물 쓰레기 1NP / 저실장 5NP / 자실장 10NP)
  - 솎아내기(마비키) 시스템 - 저실장 및 자실장 도살 가능
  - 전투 시스템 설계 (침공/방어/약탈)
  - NPC 공원 5종 성격 (야만/요새/목장/교활/파괴자)
  - 사기 시스템 (콘페이토 보너스 / 쓰레기 패널티)
- 디자인 문서 (designs.md) 작성
  - BBS 레트로 터미널 × 실장석 감성 UI 설계
  - 아스키 기반 화면 레이아웃 (로그인/대시보드/채집/전투)
  - 실장석 대사 데이터베이스 (행동별 랜덤 2~3개)
  - 말투 규칙 확립 (성체=데스, 자실장=테츄, 저실장=레후)
  - 색상 팔레트 정의
- 필수 문서 일괄 생성 (README, CHANGELOG, BUILD_GUIDE 등)
