{% extends "base.html" %}
{% block title %}{{ park.name }} - {{ t('site.title') }}{% endblock %}
{% block content %}
<div class="dashboard">
    {# === ÏÉÅÎã® Ìó§Îçî === #}
    <div class="terminal-box header-box">
        <div class="header-row">
            <span>üèïÔ∏è <strong>{{ park.name }}</strong></span>
            <span>üëë {{ current_user.username }}</span>
            <span>{{ t('dash.turn') }}: {{ park.turn_count }}</span>
            <span>‚ö° AP: <strong class="ap-count">{{ park.action_points }}/3</strong></span>
            <a href="{{ url_for('auth.logout') }}" class="logout-link">[{{ t('nav.logout') }}]</a>
        </div>
        {# [v1.2.0] ÌÑ¥ ÏøºÌÑ∞ Í≤åÏù¥ÏßÄ #}
        <div class="turn-quota-bar">
            <span class="turn-label">‚ö° {{ t('dash.turn') }}:</span>
            <div class="turn-gauge">
                <div class="turn-gauge-fill" style="width: {{ (turn_info.quota / turn_info.max * 100)|int }}%"></div>
                <span class="turn-gauge-text">{{ turn_info.quota }} / {{ turn_info.max }}</span>
            </div>
            {% if not turn_info.is_full %}
            <span class="turn-timer" id="turnTimer" data-seconds="{{ turn_info.next_regen_seconds }}">
                {{ t('dash.next_charge') }}: <span id="turnCountdown">--:--</span>
            </span>
            {% else %}
            <span class="turn-full">‚ú® {{ t('dash.full') }}</span>
            {% endif %}
        </div>
    </div>

    {# [v1.3.0] Î≥¥Ìò∏ Î™®Îìú Î∞∞ÎÑà #}
    {% if protect_info.is_protected %}
    <div class="terminal-box" style="border-color: #ffaa00; background: rgba(255,170,0,0.08);">
        <div class="box-header" style="color: #ffaa00;">{{ t('protect.title') }}</div>
        <div class="box-content" style="font-size: 12px;">
            <p style="color: #ffaa00; margin: 0 0 6px 0;">
                {{ t('protect.desc') }}
            </p>
            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                <span>{{ t('protect.guards') }}: <strong
                        style="color: {% if protect_info.guard_need > 0 %}#ff6666{% else %}#00ff41{% endif %}">
                        {{ protect_info.guard_current }}/{{ protect_info.guard_min }}</strong>
                    {% if protect_info.guard_need > 0 %}({{ t('protect.need_more', n=protect_info.guard_need) }}){% else
                    %}‚úÖ{% endif %}
                </span>
                <span>{{ t('protect.adults') }}: <strong
                        style="color: {% if protect_info.adult_need > 0 %}#ff6666{% else %}#00ff41{% endif %}">
                        {{ protect_info.adult_current }}/{{ protect_info.adult_min }}</strong>
                    {% if protect_info.adult_need > 0 %}({{ t('protect.need_more', n=protect_info.adult_need) }}){% else
                    %}‚úÖ{% endif %}
                </span>
            </div>
        </div>
    </div>
    {% endif %}

    {# === Ïù∏ÏÇ¨Îßê === #}
    <div class="greeting-bar">
        <span class="npc-speech">üí¨ "{{ greeting }}"</span>
    </div>

    {# === 3Ïó¥ ÌòÑÌô© Ìå®ÎÑê === #}
    <div class="status-panels">
        {# Í≥µÏõê ÌòÑÌô© #}
        <div class="terminal-box panel">
            <div class="box-header">{{ t('dash.park_status') }}</div>
            <div class="box-content">
                <div class="stat-line boss-line">{{ t('dash.boss') }}: 1
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: {{ park.boss_hp }}%"></div>
                        <span class="hp-text">{{ park.boss_hp }}/100</span>
                    </div>
                </div>
                <div class="stat-line">{{ t('dash.guards') }}: <strong>{{ park.guard_count }}</strong></div>
                <div class="stat-line">{{ t('dash.adults') }}: <strong>{{ park.adult_count }}</strong></div>
                <div class="stat-line">{{ t('dash.children') }}: <strong>{{ park.child_count }}</strong></div>
                <div class="stat-line">{{ t('dash.babies') }}: <strong>{{ park.baby_count }}</strong>
                    {% if park.baby_cap > 0 %}
                    <span class="cap-info">/ {{ park.baby_cap }}</span>
                    {% endif %}
                </div>
                <div class="stat-divider"></div>
                <div class="stat-line pop-line">
                    {{ t('dash.population') }}: {{ park.total_population }}/{{ park.population_cap }}
                    <div class="pop-bar">
                        <div class="pop-fill"
                            style="width: {{ [park.total_population / park.population_cap * 100, 100] | min }}%"></div>
                    </div>
                </div>
                <div class="stat-line">{{ t('dash.power') }}: <strong>{{ park.total_combat_power }}</strong></div>
                <div class="stat-line morale-line">
                    {{ t('dash.morale') }}: {{ park.morale }}/100
                    <div class="morale-bar">
                        <div class="morale-fill {% if park.morale < 30 %}low{% elif park.morale > 70 %}high{% endif %}"
                            style="width: {{ park.morale }}%"></div>
                    </div>
                </div>
            </div>
        </div>

        {# ÏûêÏõê ÌòÑÌô© #}
        <div class="terminal-box panel">
            <div class="box-header">{{ t('dash.resources') }}</div>
            <div class="box-content">
                <div class="stat-line konpeito-line">{{ t('dash.konpeito') }}: <strong>{{ park.konpeito }}</strong><span
                        class="cap-info">/{{ park.konpeito_cap }}</span>
                    <span class="np-badge">√ó10NP</span>
                </div>
                <div class="stat-line trash-line">{{ t('dash.trash') }}: <strong>{{ park.trash_food }}</strong><span
                        class="cap-info">/{{ park.trash_food_cap }}</span>
                    <span class="np-badge dim">√ó1NP</span>
                </div>
                <div class="stat-line meat-line">{{ t('dash.meat') }}: <strong>{{ park.meat_stock }}</strong>
                    <span class="np-badge">√ó5NP</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-line">{{ t('dash.material') }}: <strong>{{ park.material }}</strong><span
                        class="cap-info">{{
                        park.material_cap }}</span></div>
                <div class="stat-divider"></div>
                <div class="stat-line np-total">
                    {{ t('dash.total_np') }}: <strong class="np-value">{{ park.total_np_available }}</strong>
                </div>
                <div class="stat-line np-consume">
                    {{ t('dash.np_per_turn') }}: <strong class="np-cost">{{ park.total_np_per_turn | round(1) }}
                        NP</strong>
                </div>
            </div>
        </div>

        {# ÏãúÏÑ§ ÌòÑÌô© #}
        <div class="terminal-box panel">
            <div class="box-header">{{ t('dash.facilities') }}</div>
            <div class="box-content">
                <div class="stat-line">{{ t('dash.houses') }}: <strong>{{ park.cardboard_houses }}</strong></div>
                <div class="stat-line">{{ t('dash.burrows') }}: <strong>{{ park.unchi_holes }}</strong></div>
                <div class="stat-line">{{ t('dash.storage') }}: <strong>{{ park.storage_holes }}</strong></div>
                <div class="stat-line">{{ t('dash.walls') }}: <strong>{{ park.walls }}</strong></div>
                <div class="stat-line">{{ t('dash.watchtower') }}: <strong>{{ park.watchtowers }}</strong></div>
                {% if building_queue %}
                <div class="stat-divider"></div>
                <div class="queue-title">{{ t('dash.building_queue') }}:</div>
                {% for b in building_queue %}
                <div class="queue-item">
                    {{ buildings[b.building_type].emoji }} {{ buildings[b.building_type].name }}
                    ({{ t('dash.turns_left', n=b.turns_remaining) }})
                </div>
                {% endfor %}
                {% endif %}
                {% if training_queue %}
                <div class="stat-divider"></div>
                <div class="queue-title">{{ t('dash.training_queue') }}:</div>
                {% for tr in training_queue %}
                <div class="queue-item">{{ t('dash.guard_training') }} ({{ t('dash.turns_left', n=tr.turns_remaining)
                    }})</div>
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>

    {# === ÌñâÎèô Î©îÎâ¥ === #}
    <div class="terminal-box action-box">
        <div class="box-header">{{ t('action.title') }} ({{ t('action.ap_remaining') }}: {{ park.action_points }}/3)
        </div>
        <div class="box-content action-grid">
            {# Ï±ÑÏßë #}
            <div class="action-card" id="action-gather">
                <div class="action-title">{{ t('action.gather') }} <span class="ap-cost">1AP</span></div>
                <form method="POST" action="{{ url_for('game.gather') }}" class="action-form">
                    <div class="action-inputs">
                        <label>{{ t('dash.adults') }}: <input type="number" name="num_adults"
                                value="{{ park.gathering_adults if park.gathering_adults > 0 else (1 if park.adult_count > 0 else 0) }}"
                                min="0" max="{{ park.adult_count }}" class="num-input" id="gather-adults"></label>
                        <label>{{ t('dash.children') }}: <input type="number" name="num_children"
                                value="{{ park.gathering_children }}" min="0" max="{{ park.child_count }}"
                                class="num-input" id="gather-children"></label>
                    </div>
                    <button type="submit" class="terminal-btn btn-action" id="btn-gather" {% if park.action_points < 1
                        %}disabled{% endif %}>
                        {{ t('action.gather_go') }}
                    </button>
                </form>
            </div>

            {# Ï∂úÏÇ∞ #}
            <div class="action-card" id="action-birth">
                <div class="action-title">{{ t('action.breed') }} <span class="ap-cost">2AP</span></div>
                <p class="action-desc">{{ t('action.breed_desc') }}</p>
                <form method="POST" action="{{ url_for('game.birth') }}">
                    <button type="submit" class="terminal-btn btn-action" id="btn-birth" {% if park.action_points < 2 or
                        park.adult_count < 1 %}disabled{% endif %}>
                        {{ t('action.breed_go') }}
                    </button>
                </form>
            </div>

            {# Í±¥ÏÑ§ #}
            <div class="action-card" id="action-build">
                <div class="action-title">{{ t('action.build') }} <span class="ap-cost">1AP</span> <span
                        class="cap-info">({{ t('dash.material') }}: {{
                        park.material }})</span></div>
                <form method="POST" action="{{ url_for('game.build') }}" class="action-form">
                    <select name="building_type" class="terminal-select" id="build-select">
                        {% for key, bldg in buildings.items() %}
                        <option value="{{ key }}">
                            {{ bldg.emoji }} {{ bldg.name }} ‚Äî üß±{{ bldg.material_cost }} / {{ bldg.turns }}{{
                            t('dash.turn') }} {% if
                            park.material < bldg.material_cost %}[{{ t('action.build_insufficient') }}]{% else %}‚úÖ{%
                                endif %} </option>
                                {% endfor %}
                    </select>
                    <p class="action-desc" id="build-desc">{{ t('action.build_desc') }}</p>
                    <button type="submit" class="terminal-btn btn-action" id="btn-build" {% if park.action_points < 1
                        %}disabled{% endif %}>
                        {{ t('action.build_go') }}
                    </button>
                </form>
            </div>

            {# ÌõàÎ†® #}
            <div class="action-card" id="action-train">
                <div class="action-title">{{ t('action.train') }} <span class="ap-cost">1AP</span></div>
                <p class="action-desc">{{ t('action.train_desc') }}</p>
                <form method="POST" action="{{ url_for('game.train') }}">
                    <button type="submit" class="terminal-btn btn-action" id="btn-train" {% if park.action_points < 1 or
                        park.adult_count < 1 %}disabled{% endif %}>
                        {{ t('action.train_go') }}
                    </button>
                </form>
            </div>

            {# ÏÜéÏïÑÎÇ¥Í∏∞ - Ï†ÄÏã§Ïû• #}
            <div class="action-card cull-card" id="action-cull-baby">
                <div class="action-title">{{ t('action.cull_baby') }} <span class="ap-cost free">0AP</span></div>
                <form method="POST" action="{{ url_for('game.cull') }}" class="action-form">
                    <input type="hidden" name="target_type" value="baby">
                    <div class="action-inputs">
                        <label>{{ t('action.cull_count') }}: <input type="number" name="count" value="1" min="1"
                                max="{{ park.baby_count }}" class="num-input"></label>
                        <select name="convert_to" class="terminal-select">
                            <option value="food">{{ t('action.cull_to_food') }} (5NP)</option>
                            <option value="material">{{ t('action.cull_to_mat') }} (3)</option>
                        </select>
                    </div>
                    <button type="submit" class="terminal-btn btn-cull" id="btn-cull-baby" {% if park.baby_count < 1
                        %}disabled{% endif %}>
                        {{ t('action.cull_go') }}
                    </button>
                </form>
            </div>

            {# ÏÜéÏïÑÎÇ¥Í∏∞ - ÏûêÏã§Ïû• #}
            <div class="action-card cull-card" id="action-cull-child">
                <div class="action-title">{{ t('action.cull_child') }} <span class="ap-cost free">0AP</span></div>
                <form method="POST" action="{{ url_for('game.cull') }}" class="action-form">
                    <input type="hidden" name="target_type" value="child">
                    <div class="action-inputs">
                        <label>{{ t('action.cull_count') }}: <input type="number" name="count" value="1" min="1"
                                max="{{ park.child_count }}" class="num-input"></label>
                        <select name="convert_to" class="terminal-select">
                            <option value="food">{{ t('action.cull_to_food') }} (10NP)</option>
                            <option value="material">{{ t('action.cull_to_mat') }} (5)</option>
                        </select>
                    </div>
                    <button type="submit" class="terminal-btn btn-cull" id="btn-cull-child" {% if park.child_count < 1
                        %}disabled{% endif %}>
                        {{ t('action.cull_go') }}
                    </button>
                </form>
            </div>
        </div>
    </div>
    {# === Ï†ÑÌà¨/Î∞©Ïñ¥ Ïï°ÏÖò === #}
    <div class="terminal-box action-box">
        <div class="box-header">{{ t('battle.title') }} (AP: {{ park.action_points }}/3)</div>
        <div class="box-content action-grid">
            {# Î∞©Ïñ¥ Î∞∞Ïπò #}
            <div class="action-card" id="action-defend">
                <div class="action-title">{{ t('action.defend') }} <span class="ap-cost">1AP</span></div>
                <form method="POST" action="{{ url_for('game.defend') }}" class="action-form">
                    <div class="action-inputs">
                        <label>{{ t('dash.guards') }}: <input type="number" name="num_guards"
                                value="{{ park.defending_guards }}" min="0" max="{{ park.guard_count }}"
                                class="num-input"></label>
                        <label>{{ t('dash.adults') }}: <input type="number" name="num_adults"
                                value="{{ park.defending_adults }}" min="0" max="{{ park.adult_count }}"
                                class="num-input"></label>
                    </div>
                    <p class="action-desc">{{ t('action.defend_power') }}: <strong>{{ park.defense_power }}</strong></p>
                    <button type="submit" class="terminal-btn btn-action" id="btn-defend" {% if park.action_points < 1
                        %}disabled{% endif %}>
                        {{ t('action.defend_change') }}
                    </button>
                </form>
            </div>

            {# ÎîîÎ≤ÑÍ∑∏ ÌÑ¥ ÏßÑÌñâ #}
            <div class="action-card" id="action-debug-turn">
                <div class="action-title">{{ t('battle.debug_turn') }} <span class="ap-cost free">DEBUG</span></div>
                <p class="action-desc">{{ t('battle.debug_desc') }}</p>
                <form method="POST" action="{{ url_for('game.debug_next_turn') }}">
                    <button type="submit" class="terminal-btn btn-action" id="btn-debug-turn">
                        {{ t('battle.debug_go') }}
                    </button>
                </form>
            </div>

            {# Ï†ÑÌà¨ Í∏∞Î°ù #}
            <div class="action-card" id="action-battle-log">
                <div class="action-title">{{ t('battle.logs_title') }}</div>
                <p class="action-desc">{{ t('battle.logs_desc') }}</p>
                <a href="{{ url_for('game.battle_logs') }}" class="terminal-btn btn-action" id="btn-battle-logs">
                    {{ t('battle.logs_go') }}
                </a>
            </div>
        </div>
    </div>

    {# === Ïù¥Î≤§Ìä∏ Î°úÍ∑∏ === #}
    <div class="terminal-box log-box">
        <div class="box-header">{{ t('event.title') }}</div>
        <div class="box-content log-content">
            {% if recent_logs %}
            {% for log in recent_logs %}
            <div class="log-entry log-{{ log.event_type }}">
                <span class="log-turn">[{{ t('event.turn', turn=log.turn_number) }}]</span>
                <span class="log-msg">{{ log.message }}</span>
            </div>
            {% endfor %}
            {% else %}
            <div class="log-entry">{{ t('dash.new_park_log') }}</div>
            {% endif %}
        </div>
    </div>

    {# === Îã§Î•∏ Í≥µÏõê Î™©Î°ù (Ï†ïÏ∞∞ + Ïπ®Í≥µ) === #}
    <div class="terminal-box parks-box">
        <div class="box-header">{{ t('parks.title') }}</div>
        <div class="box-content">
            <table class="park-table">
                <thead>
                    <tr>
                        <th>{{ t('parks.name') }}</th>
                        <th>{{ t('parks.boss') }}</th>
                        <th>{{ t('parks.power') }}</th>
                        <th>{{ t('parks.personality') }}</th>
                        <th>{{ t('parks.actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in other_parks %}
                    <tr class="{% if p.is_npc %}npc-row{% endif %}">
                        <td>{{ p.name }}</td>
                        <td>{% if p.is_npc %}NPC{% else %}{{ p.owner.username if p.owner else '???' }}{% endif %}</td>
                        <td>{% if park.watchtowers > 0 %}{{ p.total_combat_power }}{% else %}???{% endif %}</td>
                        <td>
                            {% if p.is_npc %}
                            {% if p.npc_personality == 'aggressive' %}{{ t('parks.aggressive') }}
                            {% elif p.npc_personality == 'defensive' %}{{ t('parks.defensive') }}
                            {% elif p.npc_personality == 'peaceful' %}{{ t('parks.peaceful') }}
                            {% elif p.npc_personality == 'cunning' %}{{ t('parks.cunning') }}
                            {% elif p.npc_personality == 'berserk' %}{{ t('parks.berserk') }}
                            {% endif %}
                            {% else %}{{ t('parks.player') }}{% endif %}
                        </td>
                        <td>
                            <button type="button" class="terminal-btn btn-attack-sm btn-scout" data-park-id="{{ p.id }}"
                                data-park-name="{{ p.name }}">
                                {{ t('action.scout') }}
                            </button>
                            <button type="button" class="terminal-btn btn-cull btn-attack-sm btn-open-attack"
                                data-target-id="{{ p.id }}" data-target-name="{{ p.name }}" {% if park.action_points < 2
                                %}disabled{% endif %}>
                                {{ t('action.attack') }}
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if park.watchtowers == 0 %}
            <p class="hint-text">{{ t('dash.watchtower_hint') }}</p>
            {% endif %}
        </div>
    </div>

    {# === ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò === #}
    <div class="terminal-box" style="margin-top: 12px;">
        <div class="box-content" style="display: flex; gap: 10px; justify-content: center;">
            <a href="{{ url_for('game.ranking') }}" class="terminal-btn btn-action">{{ t('nav.ranking') }}</a>
            <a href="{{ url_for('game.battle_logs') }}" class="terminal-btn btn-action">{{ t('nav.battle_logs') }}</a>
            <a href="{{ url_for('game.trade_market') }}" class="terminal-btn btn-action">{{ t('nav.trade') }}</a>
        </div>
    </div>

</div>

{# Ï†ïÏ∞∞ Î™®Îã¨ (AJAX) #}
<div id="scout-modal"
    style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:100; background:#0a0f0a; border:1px solid #225522; border-radius:3px; padding:16px; min-width:300px; max-width:450px; box-shadow:0 0 30px rgba(0,255,0,0.1);">
    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
        <span style="color:#00ff88; font-weight:700;" id="scout-title">{{ t('action.scout_result') }}</span>
        <button onclick="document.getElementById('scout-modal').style.display='none'"
            style="background:none; border:none; color:#ff4444; cursor:pointer; font-size:14px;">[√ó]</button>
    </div>
    <div id="scout-content" style="font-size:12px; color:#88cc88; line-height:1.6;"></div>
</div>

{# Ïπ®Í≥µ Ïú†Îãõ ÏÑ†ÌÉù Î™®Îã¨ #}
<div id="attack-modal"
    style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:100; background:#0a0f0a; border:1px solid #552222; border-radius:3px; padding:16px; min-width:340px; max-width:460px; box-shadow:0 0 30px rgba(255,50,50,0.15);">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <span style="color:#ff6666; font-weight:700;" id="attack-title">{{ t('attack.title') }}</span>
        <button onclick="closeAttackModal()"
            style="background:none; border:none; color:#ff4444; cursor:pointer; font-size:14px;">[√ó]</button>
    </div>
    <form method="POST" action="{{ url_for('game.attack') }}" id="attack-form">
        <input type="hidden" name="target_id" id="attack-target-id" value="0">
        <div style="margin-bottom:10px; font-size:12px; color:#88cc88;">
            <div style="margin-bottom:6px;">
                {{ t('attack.send_guards') }}:
                <input type="number" name="send_guards" id="send-guards" value="0" min="0"
                    max="{{ [0, park.guard_count - park.defending_guards] | max }}" class="num-input"
                    style="width:50px; margin-left:4px;" oninput="updateAttackPreview()">
                <span class="cap-info">/ {{ [0, park.guard_count - park.defending_guards] | max }} {{
                    t('attack.available') }}</span>
            </div>
            <div style="margin-bottom:6px;">
                {{ t('attack.send_adults') }}:
                <input type="number" name="send_adults" id="send-adults" value="0" min="0"
                    max="{{ [0, park.adult_count - park.defending_adults] | max }}" class="num-input"
                    style="width:50px; margin-left:4px;" oninput="updateAttackPreview()">
                <span class="cap-info">/ {{ [0, park.adult_count - park.defending_adults] | max }} {{
                    t('attack.available') }}</span>
            </div>
            <div
                style="margin-top:8px; padding:6px; border:1px solid #553300; border-radius:2px; background:rgba(255,100,0,0.05);">
                <label style="cursor:pointer; display:flex; align-items:center; gap:6px;">
                    <input type="checkbox" name="boss_joins" id="boss-joins" onchange="updateAttackPreview()">
                    <span>{{ t('attack.boss_join') }}</span>
                </label>
                <div style="font-size:10px; color:#ff6666; margin-top:4px;">
                    {{ t('attack.boss_warning') }}
                </div>
                <div style="font-size:10px; color:#666; margin-top:2px;">
                    {{ t('attack.boss_hp') }}: <strong style="color:#ffaa00;">{{ park.boss_hp }}/100</strong>
                </div>
            </div>
        </div>
        <div
            style="margin-bottom:10px; padding:6px; border:1px solid #225522; border-radius:2px; font-size:11px; color:#aaddaa;">
            <div>{{ t('attack.preview') }}: <strong style="color:#ff8800;" id="atk-preview">0</strong></div>
        </div>
        <div style="display:flex; gap:8px;">
            <button type="submit" class="terminal-btn btn-cull" id="btn-attack-submit" style="flex:1;">{{ t('attack.go')
                }}</button>
            <button type="button" class="terminal-btn" onclick="closeAttackModal()" style="flex:0.5;">{{
                t('attack.cancel') }}</button>
        </div>
    </form>
</div>

<div id="modal-overlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:99;"
    onclick="closeAllModals()"></div>

<script>
    // === Í≤åÏûÑ ÏÉÅÏàò (Jinja2ÏóêÏÑú Ï†ÑÎã¨) ===
    const POWER_GUARD = {{ GC.POWER_GUARD }};
    const POWER_ADULT = {{ GC.POWER_ADULT }};
    const POWER_BOSS = {{ GC.POWER_BOSS }};
    const MORALE_EFFECT = {{ GC.MORALE_COMBAT_EFFECT }};
    const PARK_MORALE = {{ park.morale }};

    // [v1.4.0] i18n Î¨∏ÏûêÏó¥ (Jinja2‚ÜíJS Ï†ÑÎã¨)
    const I18N = {
        scoutTitle: "{{ t('action.scout_result') }}",
        attackTitle: "{{ t('attack.title') }}",
        attackGo: "{{ t('attack.go') }}",
        attackSelectUnit: "{{ t('attack.select_unit') }}",
        scoutPopulation: "{{ t('dash.population') }}",
        scoutGuards: "{{ t('dash.guards') }}",
        scoutAdults: "{{ t('dash.adults') }}",
        scoutChildren: "{{ t('dash.children') }}",
        scoutBabies: "{{ t('dash.babies') }}",
        scoutPower: "{{ t('dash.power') }}",
        scoutDefense: "{{ t('action.defend_power') }}",
        scoutWalls: "{{ t('dash.walls') }}",
        scoutMorale: "{{ t('dash.morale') }}",
        scoutNeedTower: "{{ t('dash.watchtower_hint') }}",
        scoutFail: "{{ t('common.error') }}",
        nextCharge: "{{ t('dash.next_charge') }}",
        charging: "{{ t('dash.charging') }}"
    };

    // === Î™®Îã¨ Í¥ÄÎ¶¨ ===
    function closeAllModals() {
        document.getElementById('scout-modal').style.display = 'none';
        document.getElementById('attack-modal').style.display = 'none';
        document.getElementById('modal-overlay').style.display = 'none';
    }
    function closeAttackModal() {
        document.getElementById('attack-modal').style.display = 'none';
        document.getElementById('modal-overlay').style.display = 'none';
    }

    // === [v1.5.0] XSS Î∞©ÏßÄ Ïú†Ìã∏ Ìï®Ïàò ===
    // HTML ÌäπÏàòÎ¨∏ÏûêÎ•º Ïù¥Ïä§ÏºÄÏù¥ÌîÑÌïòÏó¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ï£ºÏûÖÏùÑ ÏõêÏ≤ú Ï∞®Îã®
    function escapeHtml(str) {
        if (typeof str !== 'string') return String(str);
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // === Ï†ïÏ∞∞ Î≤ÑÌäº Ï≤òÎ¶¨ ===
    document.querySelectorAll('.btn-scout').forEach(btn => {
        btn.addEventListener('click', async () => {
            const parkId = btn.dataset.parkId;
            const parkName = btn.dataset.parkName;
            try {
                const res = await fetch(`{{ url_for('game.scout', target_id=0) }}`.replace('/0', '/' + parkId));
                const data = await res.json();
                const modal = document.getElementById('scout-modal');
                const content = document.getElementById('scout-content');
                document.getElementById('scout-title').textContent = `üëÅÔ∏è ${parkName}`;

                // [v1.5.0] XSS Î∞©ÏßÄ: ÏÑúÎ≤Ñ ÏùëÎãµ Îç∞Ïù¥ÌÑ∞Î•º Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Ï≤òÎ¶¨
                let html = `<p style="color:#ffaa00; margin-bottom:6px;">${escapeHtml(data.message)}</p>`;
                const d = data.data;
                html += `<div>üè† ${escapeHtml(I18N.scoutPopulation)}: <strong>${Number(d.total_population)}</strong></div>`;

                if (data.has_watchtower) {
                    html += `<div>${escapeHtml(I18N.scoutGuards)}: <strong>${Number(d.guard_count)}</strong></div>`;
                    html += `<div>${escapeHtml(I18N.scoutAdults)}: <strong>${Number(d.adult_count)}</strong></div>`;
                    html += `<div>${escapeHtml(I18N.scoutChildren)}: <strong>${Number(d.child_count)}</strong></div>`;
                    html += `<div>${escapeHtml(I18N.scoutBabies)}: <strong>${Number(d.baby_count)}</strong></div>`;
                    html += `<div style="margin-top:4px;">${escapeHtml(I18N.scoutPower)}: <strong style="color:#ff8800;">${Number(d.total_combat_power)}</strong></div>`;
                    html += `<div>üõ°Ô∏è ${escapeHtml(I18N.scoutDefense)}: <strong>${Number(d.defense_power)}</strong></div>`;
                    html += `<div>${escapeHtml(I18N.scoutWalls)}: <strong>${Number(d.walls)}</strong></div>`;
                    html += `<div>${escapeHtml(I18N.scoutMorale)}: <strong>${Number(d.morale)}/100</strong></div>`;
                } else {
                    html += `<p style="color:#666; font-style:italic; margin-top:6px;">${escapeHtml(I18N.scoutNeedTower)}</p>`;
                }

                content.innerHTML = html;
                modal.style.display = 'block';
                document.getElementById('modal-overlay').style.display = 'block';
            } catch (e) {
                alert(I18N.scoutFail);
            }
        });
    });

    // === Ïπ®Í≥µ Î≤ÑÌäº ‚Üí Î™®Îã¨ Ïó¥Í∏∞ ===
    document.querySelectorAll('.btn-open-attack').forEach(btn => {
        btn.addEventListener('click', () => {
            const targetId = btn.dataset.targetId;
            const targetName = btn.dataset.targetName;
            document.getElementById('attack-target-id').value = targetId;
            document.getElementById('attack-title').textContent = `‚öîÔ∏è ${targetName}`;

            // Í∏∞Î≥∏Í∞í Ï¥àÍ∏∞Ìôî
            document.getElementById('send-guards').value = document.getElementById('send-guards').max;
            document.getElementById('send-adults').value = 0;
            document.getElementById('boss-joins').checked = false;
            updateAttackPreview();

            document.getElementById('attack-modal').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'block';
        });
    });

    // === Ï†ÑÌà¨Î†• ÎØ∏Î¶¨Î≥¥Í∏∞ Í≥ÑÏÇ∞ ===
    function updateAttackPreview() {
        const guards = parseInt(document.getElementById('send-guards').value) || 0;
        const adults = parseInt(document.getElementById('send-adults').value) || 0;
        const bossJoins = document.getElementById('boss-joins').checked;

        let power = guards * POWER_GUARD + adults * POWER_ADULT;
        if (bossJoins) power += POWER_BOSS;

        // ÏÇ¨Í∏∞ Î≥¥Ï†ï (Í∑ºÏÇ¨Í∞í)
        const moraleMult = 1.0 + (PARK_MORALE - 50) * MORALE_EFFECT / 50;
        power = Math.max(1, Math.round(power * moraleMult));

        document.getElementById('atk-preview').textContent = power;

        // Ï∂úÏ†ï Ïù∏Ïõê 0Î™ÖÏù¥Î©¥ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
        const submitBtn = document.getElementById('btn-attack-submit');
        if (guards + adults === 0 && !bossJoins) {
            submitBtn.disabled = true;
            submitBtn.textContent = I18N.attackSelectUnit || '‚öîÔ∏è ...';
        } else {
            submitBtn.disabled = false;
            submitBtn.textContent = I18N.attackGo;
        }
    }

    // ============================================================
    // [v0.4.0] Ïã§ÏãúÍ∞Ñ ÏïåÎ¶º Ìè¥ÎßÅ (10Ï¥àÎßàÎã§ ÏÑúÎ≤Ñ ÌôïÏù∏)
    // ============================================================
    (function () {
        let lastNotifId = 0;
        const POLL_INTERVAL = 10000;
        const container = document.createElement('div');
        container.id = 'notif-container';
        container.style.cssText = 'position:fixed; top:10px; right:10px; z-index:9999; display:flex; flex-direction:column; gap:6px; max-width:320px;';
        document.body.appendChild(container);

        const typeStyle = {
            'battle': { icon: '‚öîÔ∏è', color: '#ff4444', bg: 'rgba(255,68,68,0.15)' },
            'trade': { icon: 'üì¶', color: '#ffaa00', bg: 'rgba(255,170,0,0.15)' },
            'diplomacy': { icon: 'ü§ù', color: '#44aaff', bg: 'rgba(68,170,255,0.15)' },
        };

        function showToast(notif) {
            const style = typeStyle[notif.type] || { icon: 'üì¢', color: '#aaa', bg: 'rgba(170,170,170,0.15)' };
            const toast = document.createElement('div');
            toast.style.cssText = `
                background: ${style.bg};
                border: 1px solid ${style.color};
                border-radius: 4px;
                padding: 8px 12px;
                color: #aaddaa;
                font-size: 12px;
                animation: slide-in 0.3s ease;
                cursor: pointer;
                backdrop-filter: blur(4px);
            `;
            // [v1.5.0] XSS Î∞©ÏßÄ: innerHTML ÎåÄÏã† ÏïàÏ†ÑÌïú DOM Íµ¨ÏÑ±
            const iconSpan = document.createElement('span');
            iconSpan.style.fontSize = '14px';
            iconSpan.textContent = style.icon;
            const msgSpan = document.createElement('span');
            msgSpan.textContent = ' ' + notif.message;
            toast.appendChild(iconSpan);
            toast.appendChild(msgSpan);
            toast.onclick = () => toast.remove();
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.5s';
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        }

        async function pollNotifications() {
            try {
                const res = await fetch('/game/api/notifications?last_id=' + lastNotifId);
                const data = await res.json();
                if (data.notifications && data.notifications.length > 0) {
                    data.notifications.forEach(n => {
                        showToast(n);
                        if (n.id > lastNotifId) lastNotifId = n.id;
                    });
                }
            } catch (e) { }
        }

        fetch('/game/api/notifications?last_id=0')
            .then(r => r.json())
            .then(data => {
                if (data.notifications && data.notifications.length > 0) {
                    lastNotifId = Math.max(...data.notifications.map(n => n.id));
                }
            })
            .catch(() => { });

        setInterval(pollNotifications, POLL_INTERVAL);
    })();

    // [v1.2.0] ÌÑ¥ Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÌÉÄÏù¥Î®∏
    (function () {
        const timerEl = document.getElementById('turnTimer');
        if (!timerEl) return;
        let seconds = parseInt(timerEl.dataset.seconds || '0');
        const countdownEl = document.getElementById('turnCountdown');

        function updateCountdown() {
            if (seconds <= 0) {
                countdownEl.textContent = I18N.charging || '...';
                setTimeout(() => location.reload(), 1000);
                return;
            }
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            countdownEl.textContent = `${min}:${sec.toString().padStart(2, '0')}`;
            seconds--;
            setTimeout(updateCountdown, 1000);
        }
        updateCountdown();
    })();
</script>
{% endblock %}